# 对话内容查看前端页面

## 功能说明

前端对话内容查看页面已集成到管理后台中，允许管理员（Root用户）查看通过API中转的完整对话内容。

## 访问路径

- **URL**: `/console/content-log`
- **权限**: 仅管理员（Root User）可访问
- **菜单位置**: 侧边栏 → 管理员 → 对话内容

## 功能特性

### 1. 对话列表展示

- ✅ 显示所有用户的对话记录
- ✅ 包含以下信息：
  - 时间
  - 用户名
  - 令牌名称
  - 模型名称
  - 输入/输出 tokens
  - 花费
  - 渠道信息

### 2. 筛选和搜索

支持多种筛选条件：
- 用户名
- 令牌名称
- 模型名称
- 渠道ID
- 时间范围

### 3. 对话内容查看

点击"查看对话"按钮，可以在弹窗中查看：
- **用户请求**: 完整的请求JSON内容
- **AI响应**: 完整的响应内容
- 支持复制请求和响应内容
- 自动格式化JSON显示

### 4. 分页功能

- 支持每页显示 10/20/50/100 条记录
- 页码导航

## 使用步骤

### 1. 启用后端功能

首先确保后端的对话内容记录功能已启用：

```bash
# 在 .env 文件中设置
CONTENT_LOGGING_ENABLED=true
CONTENT_RETENTION_DAYS=7
MAX_CONTENT_LENGTH=10000
```

### 2. 执行数据库迁移

如果是首次使用，需要执行数据库迁移：

```bash
mysql -u root -p your_database < scripts/migrate_add_content_fields.sql
```

### 3. 访问前端页面

1. 以管理员身份登录系统
2. 在侧边栏找到"管理员"分组
3. 点击"对话内容"菜单项
4. 即可查看所有对话记录

### 4. 查看对话详情

1. 在列表中找到要查看的记录
2. 点击"查看对话"按钮
3. 在弹窗中切换"用户请求"和"AI响应"标签页
4. 可以点击"复制"按钮复制内容

## 界面截图说明

### 主界面
- 顶部：刷新按钮
- 中间：筛选条件（用户名、令牌、模型、渠道、时间范围）
- 下方：对话记录列表
- 底部：分页控件

### 对话详情弹窗
- 标题：对话内容详情
- 标签页1：用户请求（显示请求JSON）
- 标签页2：AI响应（显示响应内容）
- 每个标签页都有复制按钮

## 技术实现

### 前端文件结构

```
web/src/
├── pages/ContentLog/
│   └── index.jsx                          # 页面入口
├── components/table/content-logs/
│   ├── index.jsx                          # 主组件
│   ├── ContentLogsTable.jsx               # 表格组件
│   ├── ContentLogsActions.jsx             # 操作按钮
│   ├── ContentLogsFilters.jsx             # 筛选组件
│   └── modals/
│       └── ContentModal.jsx               # 对话详情弹窗
└── hooks/content-logs/
    └── useContentLogsData.jsx             # 数据管理Hook
```

### API接口

- `GET /api/log/content` - 获取对话列表
  - 参数：page, page_size, username, model_name, token_name, channel, start_timestamp, end_timestamp
  - 返回：分页的对话记录列表

- `GET /api/log/content/:id` - 获取单条对话详情（当前未使用，列表已包含完整内容）

## 注意事项

### 权限要求

- 只有 Root 管理员可以访问此页面
- 普通管理员和用户无法查看对话内容
- 如果非管理员尝试访问，会被重定向到403页面

### 隐私和安全

1. **敏感信息**: 对话内容可能包含用户的敏感信息，请谨慎使用
2. **访问日志**: 建议记录管理员访问对话内容的操作（待实现）
3. **数据保留**: 默认7天后自动清理，可在系统设置中修改
4. **合规要求**: 使用前请确保符合相关隐私法规（GDPR、CCPA等）

### 性能考虑

1. **大量数据**: 如果对话记录很多，建议使用筛选条件缩小范围
2. **内容长度**: 超长内容会被截断显示，完整内容可通过复制查看
3. **刷新频率**: 避免频繁刷新，以减少服务器负载

## 常见问题

### Q1: 为什么看不到"对话内容"菜单？

**A**: 请确认：
1. 你是以 Root 管理员身份登录
2. 后端功能已启用（CONTENT_LOGGING_ENABLED=true）
3. 数据库迁移已完成

### Q2: 列表为空，没有任何记录？

**A**: 可能的原因：
1. 后端功能未启用
2. 还没有新的API请求（功能启用后才会记录）
3. 记录已被自动清理（超过保留期限）

### Q3: 对话内容显示不完整？

**A**: 这是正常的，因为：
1. 后端设置了最大内容长度限制（默认10000字符）
2. 超过限制的内容会被截断并标记"[截断]"
3. 可以在系统设置中调整 MAX_CONTENT_LENGTH

### Q4: 如何导出对话记录？

**A**: 当前版本暂不支持导出功能，计划在后续版本中添加。临时方案：
1. 使用浏览器的复制功能
2. 直接查询数据库导出

## 后续改进计划

- [ ] 添加导出功能（CSV/JSON）
- [ ] 支持关键词搜索对话内容
- [ ] 添加审计日志（记录管理员查看操作）
- [ ] 支持按用户ID筛选
- [ ] 添加统计图表
- [ ] 支持批量操作

## 相关文档

- [后端功能文档](./CONTENT_LOGGING.md)
- [实现总结](../CONTENT_LOGGING_SUMMARY.md)
- [数据库迁移说明](../scripts/README_MIGRATION.md)

---

**更新日期**: 2025-01-17  
**版本**: v1.0.0
