name: Enable GitHub Sync Feature

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'ç¡®è®¤å¯ç”¨ GitHub åŒæ­¥åŠŸèƒ½ (yes/no)'
        required: true
        default: 'no'

jobs:
  enable-github-sync:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'yes'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      
      - name: Restore github_sync.go
        run: |
          echo "æ¢å¤ GitHub åŒæ­¥æœåŠ¡æ–‡ä»¶..."
          if [ -f service/github_sync.go.bak ]; then
            mv service/github_sync.go.bak service/github_sync.go
            echo "âœ… å·²æ¢å¤ service/github_sync.go"
          else
            echo "âš ï¸ å¤‡ä»½æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡"
          fi
      
      - name: Add dependencies to go.mod
        run: |
          echo "æ·»åŠ ä¾èµ–åˆ° go.mod..."
          go get github.com/google/go-github/v50@v50.2.0
          go get golang.org/x/oauth2@v0.0.0-20220223155221-ee480838109b
      
      - name: Run go mod tidy
        run: |
          echo "è¿è¡Œ go mod tidy è¡¥å…¨æ‰€æœ‰ä¾èµ–..."
          go mod tidy
          echo "âœ… ä¾èµ–å·²æ›´æ–°"
      
      - name: Verify changes
        run: |
          echo "éªŒè¯æ–‡ä»¶å˜æ›´..."
          git status
          echo ""
          echo "go.mod å˜æ›´:"
          git diff go.mod || echo "æ— å˜æ›´"
          echo ""
          echo "go.sum å˜æ›´:"
          git diff go.sum | head -20 || echo "æ— å˜æ›´"
      
      - name: Commit and push changes
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          
          git add service/github_sync.go go.mod go.sum
          
          if git diff --staged --quiet; then
            echo "âš ï¸ æ²¡æœ‰éœ€è¦æäº¤çš„å˜æ›´"
          else
            git commit -m "feat: enable GitHub sync feature

- Restore service/github_sync.go from backup
- Add required dependencies to go.mod
- Update go.sum with all transitive dependencies
- Feature enabled via GitHub Actions automation"
            
            git push
            echo "âœ… å˜æ›´å·²æäº¤å¹¶æ¨é€"
          fi
      
      - name: Summary
        run: |
          echo "=========================================="
          echo "GitHub åŒæ­¥åŠŸèƒ½å·²æˆåŠŸå¯ç”¨ï¼"
          echo "=========================================="
          echo ""
          echo "ğŸ“ éœ€è¦é…ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š"
          echo "  - GITHUB_SYNC_TOKEN=your_github_token"
          echo "  - GITHUB_SYNC_REPO=https://github.com/owner/repo"
          echo "  - GITHUB_SYNC_INTERVAL=300 (å¯é€‰)"
          echo ""
          echo "ğŸ“– è¯¦ç»†æ–‡æ¡£ï¼š"
          echo "  - docs/GITHUB_SYNC.md"
          echo "  - docs/ENABLE_GITHUB_SYNC.md"
          echo "=========================================="